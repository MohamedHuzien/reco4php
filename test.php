<?php

require_once __DIR__.'/vendor/autoload.php';

use GraphAware\Reco4PHP\Persistence\DatabaseService;
use GraphAware\Reco4PHP\RecommenderService;
use GraphAware\Reco4PHP\Tests\Demo\DummyEngine;

$recommender = new \GraphAware\Reco4PHP\Tests\Example\ExampleRecommenderService("bolt://localhost");

$s = microtime(true);
//$recommendations = $recommender->recommendMovieForUserWithId('460');
$e = microtime(true);
echo ($e - $s) . PHP_EOL;

//print_r($recommendations->getItems(3));

$db = new DatabaseService("bolt://localhost");
$movies = [7073, 7074, 7090, 7102, 6934, 6942, 6947, 6996, 6711, 6785, 6808, 6893, 6541, 6630, 6650, 6663, 6503, 6427, 6539, 6537, 6356, 6303, 6378, 6377, 5952, 5782, 6297, 6218, 5602, 5500, 5604, 5603, 38038, 40629, 33004, 33794, 30816, 31923, 27815, 30793, 8961, 26085, 8665, 8798, 8623, 8636, 8596, 8614, 8493, 8360, 8183, 7918, 7757, 7720, 7618, 7569, 7482, 7458, 7361, 7162, 7155, 7153, 7147, 7143, 3744, 3729, 3771, 3751, 3793, 3788, 3868, 3836, 3977, 3967, 3988, 3984, 4014, 3996, 4022, 4016, 3471, 3498, 3527, 3545, 3578, 3623, 3633, 3635, 3639, 3671, 3681, 3682, 3684, 3703, 3704, 3705, 4981, 4973, 4963, 4941, 5049, 5013, 4995, 4993, 5378, 5377, 5349, 5218, 5470, 5445, 5418, 5383, 4225, 4246, 4025, 4085, 4306, 4308, 4270, 4299, 4499, 4571, 4310, 4370, 4879, 4886, 4677, 4855, 2381, 2359, 2396, 2383, 2294, 2291, 2355, 2313, 2501, 2470, 2605, 2571, 2424, 2406, 2467, 2455, 2072, 2078, 2080, 2081, 2012, 2028, 2054, 2058, 2194, 2245, 2268, 2269, 2083, 2085, 2115, 2174, 3108, 3101, 3060, 2997, 2993, 2991, 2987, 2951, 3396, 3258, 3253, 3248, 3175, 3159, 3153, 3114, 2706, 2761, 2643, 2683, 2641, 2642, 2628, 2640, 2948, 2949, 2944, 2947, 2858, 2916, 2791, 2808, 1219, 1214, 1210, 1206, 1225, 1223, 1221, 1220, 1197, 1196, 1188, 1148, 1204, 1201, 1200, 1198, 1287, 1291, 1275, 1277, 1304, 1333, 1296, 1303, 1246, 1247, 1234, 1240, 1265, 1270, 1262, 1263, 1517, 1485, 1542, 1527, 1573, 1544, 1608, 1580, 1373, 1357, 1380, 1374, 1391, 1387, 1441, 1393, 1721, 1947, 1951, 1957, 1961, 2004, 2005, 2011, 1610, 1617, 1641, 1643, 1674, 1676, 1682, 1704, 497, 480, 466, 457, 442, 440, 434, 432, 420, 380, 377, 370, 368, 367, 364, 362, 648, 653, 595, 597, 593, 594, 589, 592, 587, 588, 539, 541, 520, 534, 500, 515, 919, 914, 965, 924, 904, 902, 912, 908, 786, 356, 357, 344, 349, 339, 342, 318, 329, 296, 316, 208, 260, 165, 168, 150, 153, 110, 105, 95, 66, 50, 34, 32, 19, 10, 2, 1, 1035, 1029, 1028, 1023, 1079, 1073, 1059, 1036, 1097, 1090, 1089, 1080, 1135, 1127, 1125, 1101, 745, 750, 733, 736, 832, 858, 780];

$q = "MATCH (m:Movie) WHERE m.id IN {movies}
MATCH (m)<-[:RATED]-(u:User)
WITH distinct u
MATCH (u)-[r:RATED]->(reco:Movie)
RETURN reco, sum(r.rating) as score
ORDER BY score DESC
LIMIT 500";

$s = microtime(true);
$result = $db->getDriver()->run($q, ['movies' => $movies]);
$e = microtime(true);

echo ($e - $s) . PHP_EOL;